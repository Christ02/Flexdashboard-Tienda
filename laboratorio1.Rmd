---
title: "Análisis de Rentabilidad de Productos"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(readr)
library(dplyr)
library(DT)
library(leaflet)
library(leaflet.extras)
library(flexdashboard)
library(ggplot2)
library(plotly)
library(crosstalk)

# Load and prepare data
tienda <- read_csv("tienda.csv", locale = locale(encoding = "ISO-8859-1"))
Tienda_coords <- read_csv("Tienda_coords.csv", locale = locale(encoding = "UTF-8"))

# Filter the desired categories (optional, as per your requirement)
# Combine filters for Category, Region, and Segment
tienda_filtered <- tienda %>%
  filter(Category %in% c("Technology", "Office Supplies", "Furniture"),
         Region %in% c("North", "South", "East", "West"),
         Segment %in% c("Consumer", "Corporate", "Home Office"))
```

# Productos Más y Menos Rentables {data-icon="fa-bar-chart"}

### {data-width=10%}
```{r Mas Menos Rentable}
rentabilidad_productos <- tienda %>%
  group_by(`Product Name`) %>%  # Usar comillas invertidas para el nombre de la columna con espacio
  summarise(
    total_sales = sum(Sales, na.rm = TRUE),  # Sumar ventas, eliminando valores NA
    total_profit = sum(Profit, na.rm = TRUE),  # Sumar ganancias, eliminando valores NA
    avg_profit = mean(Profit, na.rm = TRUE)  # Calcular promedio de ganancias, eliminando valores NA
  ) %>%
  arrange(desc(total_profit))

DT::datatable(rentabilidad_productos, options = list(pageLength = 10))
```

## Top rentabilidad de productos mas{data-width=50%} 
```{r}
# Gráfico de los 10 productos más rentables
top_rentabilidad_productos <- rentabilidad_productos %>%
  top_n(10, total_profit)  # Seleccionar los 10 productos más rentables

p1 <- ggplot(top_rentabilidad_productos, aes(x = reorder(`Product Name`, total_profit), y = total_profit)) +
  geom_bar(stat = "identity", fill = "green") +
  coord_flip() +
  labs(title = "Top 10 Productos Más Rentables", x = "Producto", y = "Ganancia Total") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 1),  # Adjust font size
        axis.text.x = element_text(angle = 90, hjust = 1))  # Rotate x-axis labels

# Convertir gráficos a objetos interactivos con plotly
plotly_p1 <- ggplotly(p1)
plotly_p1
```

## Top rentabilidad de productos menos{data-width=50%}  
```{r}
# Gráfico de los 10 productos menos rentables
bottom_rentabilidad_productos <- rentabilidad_productos %>%
  top_n(-10, total_profit)  # Seleccionar los 10 productos menos rentables
# Crear gráfico de barras para productos menos rentables
p2 <- ggplot(bottom_rentabilidad_productos, aes(x = reorder(`Product Name`, total_profit), y = total_profit)) +
  geom_bar(stat = "identity", fill = "red") +
  coord_flip() +
  labs(title = "Top 10 Productos Menos Rentables", x = "Producto", y = "Pérdida Total") +
  theme_minimal() +
    theme(axis.text.y = element_text(size = 1),  # Adjust font size
        axis.text.x = element_text(angle = 90, hjust = 1))  # Rotate x-axis labels

plotly_p2 <- ggplotly(p2)
plotly_p2
```


# Análisis de Segmentos de Ventas y Ganancia {data-icon="fa-pie-chart"}
## x
###  {data-width="10%"}
```{r}
segmento_ventas_ganancias <- tienda %>%
  group_by(Category) %>%  
  summarise(
    TotalSales = sum(Sales),
    TotalProfit = sum(Profit),
    AverageProfit = mean(Profit)  
  ) %>%
  arrange(desc(TotalProfit))  


DT::datatable(segmento_ventas_ganancias, options = list(pageLength = 5))
```

### Análisis por Región
```{r}
segmento_ventas_ganancias_region <- tienda %>%
  group_by(Region) %>%  
  summarise(
    TotalSales = sum(Sales),
    TotalProfit = sum(Profit),
    AverageProfit = mean(Profit)  
  ) %>%
  arrange(desc(TotalProfit))  

DT::datatable(segmento_ventas_ganancias_region, options = list(pageLength = 5))
```
## y
### Análisis por Segmento de Clientes

```{r}
segmento_ventas_ganancias_cliente <- tienda %>%
  group_by(Segment) %>%  
  summarise(
    TotalSales = sum(Sales),
    TotalProfit = sum(Profit),
    AverageProfit = mean(Profit)  
  ) %>%
  arrange(desc(TotalProfit))  

DT::datatable(segmento_ventas_ganancias_cliente, options = list(pageLength = 5))
```

### 

```{r}
# Summarize the data by Category
segmento_ventas_ganancias <- tienda %>%
  group_by(Category) %>%  
  summarise(
    TotalSales = sum(Sales, na.rm = TRUE),
    TotalProfit = sum(Profit, na.rm = TRUE),
    AverageProfit = mean(Profit, na.rm = TRUE)
  ) %>%
  arrange(desc(TotalProfit))

# Create a ggplot2 bar chart
p <- ggplot(segmento_ventas_ganancias, aes(x = Category, y = AverageProfit, fill = Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Comparación de Profit Promedio por Categoría", x = "Categoría", y = "Profit Promedio") +
  theme_minimal()

# Convert the plot to a plotly object for interactivity
plotly_p <- ggplotly(p)

# Display the interactive plot
plotly_p
```


# Análisis Geográfico de Ventas y Ganancias {data-icon="fa-globe"}

```{r}
# Wrap your data with SharedData for crosstalk interactivity
shared_tienda_coords <- SharedData$new(Tienda_coords)

# Add a filter_slider for Profit
filter_slider("Profit", "Filtrar por Ganancia", shared_tienda_coords, ~Profit, 
              step = 500, width = '100%')

# Create the map with the filtered data
mapa <- leaflet(shared_tienda_coords) %>%
  addTiles() %>%  # Agregar capa de mapa base
  setView(lng = mean(Tienda_coords$lon, na.rm = TRUE), 
          lat = mean(Tienda_coords$lat, na.rm = TRUE), 
          zoom = 5) %>%  # Ajustar el zoom inicial según sea necesario
  addCircleMarkers(
    lng = ~lon,
    lat = ~lat,
    radius = 5,  # Tamaño de los marcadores
    color = "blue",  # Color de los marcadores
    popup = ~paste(
      "<b>City:</b>", City, "<br>",
      "<b>State:</b>", State, "<br>",
      "<b>Country:</b>", Country, "<br>",
      "<b>Sales:</b>", Sales, "<br>",
      "<b>Profit:</b>", Profit
    )
  )

# Mostrar el mapa
mapa
```

